# CITES'N'Blocks Exporter

This is a server implementation to export objects from the blockchain of the distributed CITES application and convert them into different file types like XML.

## Getting Started

### Installation

Just clone the repository to your local client.

```shell
git clone https://github.com/cites-on-blocks/cites-on-blocks_exporter.git
```

### Pre-Requisites

The `bootstrap` script should do the most to set up the whole environment on first time starting the server.

**Key & Certificate**
As long as it runs in the `developmen` mode, it also generate a new HTTPS key and certificate.
These are not used in `productive` mode. Please place the related key and certificate at `./certificates/` to get this work.

**Contract Artifacts**
Furthermore the server needs some information about the contract from which to export the data.
Cause this is a separated project from the DApp, this needs to be done once manually by the user for each new deployment.
The server expects two files per contract at the `./data/` directory.
One for the _ABI_ and one including the address of the most recent deployment.
The first object gets generated by _Truffle_ and can be found and copied from the DApp project at `./build/contracts/CONTRACT_NAME.json`.
This only changes when re-compile a new version of this contract.
The second object needs to be created as `CONTRACT_NAME.address` by the user and contains only the address of the block the contracts has been deployed to.
This will change each time the contract gets re-deployed and must be adjusted.
The server will still work on a wrong address, but can't read any data from the contract, so always a `404` gets returned.
Check the log files to be sure this is the problem.

### Startup

If all pre-requisites are fine, the sever can be started simply by using one of the defined _Node_ project targets like `npm run dev` or `npm run prd`.
In special case you can start the server manually with `node src/server.js`. Make sure to define the correct environment variable with `NODE_ENV='my-environment'`.
Be aware that all property files, which are environment specific, need to be extended by this (new) environment.

## Configuration

All configurations for the server have to be defined before startup and can't be changed during runtime.
Each property file is placed at the `./src/confg/` directory.

### General

The general properties is a collection of configuration values, which are not part of one of the following
more specialized topics. The file is called `general_prop.js`.

| Key                  | Description                                             |
| :------------------- | :------------------------------------------------------ |
| `port_http`          | Port where to listen for HTTP connections.              |
| `port_https`         | Port where to listen for HTTPS connections.             |
| `eth_provider`       | URL to the provider of the Ethereum network.            |
| `cacheFolder`        | Folder as root where to place converted files as cache. |
| `xmlConverterConfig` | Configuration object for the XML-JS converter.          |

### Logging

Property values for logging purpose are defined in the `log_prop.js` file.

| Key              | Description                                                                             |
| :--------------- | :-------------------------------------------------------------------------------------- |
| `path_dir`       | The folder where to place the log files.                                                |
| `path_files`     | List of file names the logger can use to log in for different purposes.                 |
| `options_bunyan` | Configuration object for the Bunyan logger. Contains i.a. level, rotating-requency, ... |

### SSL

Collection of values regarding the HTTPS connection with SSL/TSL. Mind that the port used for HTTPS is
defined in the [general properties](#General). The configuration file is called `ssl_prop.js`.

| Key              | Description                                                       |
| :--------------- | :---------------------------------------------------------------- |
| `options_https`  | Configuration object for the HTTPS module.                        |
| `options_sslify` | Configuration object for the SSLify module to enforce encryption. |
| `paths`          | List of paths for files to load used by the bootstrap script.     |

### Contract

This is not a simple property file, but contains a lot of more logic to connect to the Ethereum provider
already. The script is called `contract_prop.js` and contains the following adjustable variables:

| Key          | Definition                                        |
| :----------- | :------------------------------------------------ |
| `dataFolder` | Folder where the contract artifacts can be found. |

All contracts that will be loaded are statically defined in the `./src/constants/contractNames.js` constants
file.
